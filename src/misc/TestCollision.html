<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script type="text/javascript" src="../js/world.js"></script>
    <script type="text/javascript" src="../js/agent.js"></script>
    <script type="text/javascript" src="../js/wall.js"></script>
    <script type="text/javascript" src="../js/graph/Geometry.js"></script>
    <script type="text/javascript" src="../js/graph/Graph.js"></script>
    <script>

        var world = null;
        var canvasElement = null;
        var canvasContext = null;
        var speed = 1;
        var mouseVertex = Vertex(0, 0);
        var mainLoop = null;
        var lastUpdate = Date.now();
        var dt = 0;
        var wallList = [];

        function updateTime() {
            var now = Date.now();
            dt = now - lastUpdate;
            lastUpdate = now;
        }

        function update() {
            updateTime();
            world.update(dt * speed);
            canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
            world.draw(canvasContext);

            var collision = false;
            var edgemouse = new Edge(new Vertex(canvasElement.width / 2, canvasElement.height / 2), mouseVertex);
            for (var i = 0, size = wallList.length; i < size; i++) {
                if (doEdgeIntersectsWall(edgemouse, wallList[i])) {
                    collision = true;
                    break;
                }
            }

            canvasContext.strokeStyle="rgba(0, 0, 255, 1)";
            if (collision) {
                canvasContext.strokeStyle = "rgba(255, 0, 0, 1)";
            }
            canvasContext.beginPath();
            canvasContext.moveTo(edgemouse.a.x, edgemouse.a.y);
            canvasContext.lineTo(edgemouse.b.x, edgemouse.b.y);
            canvasContext.stroke();
        }

        function init() {
            mouseVertex = Vertex(0, 0);
            canvasElement = document.getElementById("canvas");
            canvasContext = this.canvasElement.getContext("2d");

            world = new World(canvasElement.width, canvasElement.height);

            for(var i = 0; i < 6; i++) {
                var wall = new Wall();
                world.addAgent(wall);
                wall.moveTo(canvasElement.width * Math.random(), canvasElement.height * Math.random());
                wallList.push(wall);
            }

            var fps = 120;
            mainLoop = setInterval(update, 1000 / fps);

            document.getElementById('canvas').addEventListener('mousemove', function(evt) {
                var rect = canvasElement.getBoundingClientRect();
                mouseVertex = new Vertex(evt.clientX - rect.left, evt.clientY - rect.top);
            }, false);
        }


        var edgeList = [];

        var time = new Date().getTime();
        var counter = 0;
        for (var x = 0; x < 50 * 20; x++) {
            for (var i = 0; i < 20; i++) {
                var edge = new Edge(new Vertex(0, 10), new Vertex(20, 10));
                for (var j = 0, size = wallList.length; j < size; j++) {
                    doEdgeIntersectsWall(edge, wallList[j]);
                    counter++;
                }
            }
        }


        console.log("time = " + (new Date().getTime() - time) + "ms, counter = " + counter);
    </script>
</head>
<body onload="init()">
    <canvas id="canvas" width="600" height="600" style="background-color:#eee; display:inline-block"></canvas>
</body>
</html>